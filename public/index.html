<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Test</title>
  </head>
  <body>
    <div id="page1">
        <p>Hello, Player</p>
        <div id="buttonbar">
            <button type="button" onclick="strangerClick()">Play Stranger</button>
            <button type="button" onclick="friendClick()">Play Friend</button>
        </div>
    </div>
    <div id="status">
    </div>
    <canvas id="back" style="border:1px solid"></canvas>
    <script src="./js/glue.js" type="text/javascript"></script>
    <script src="./js/snake.js" type="text/javascript"></script>
    <script>
        var socket = glue();
        initializeCanvas();
        initializeSocket(socket);
        initializeKeypresses();

        function strangerClick(){
            document.getElementById("page1").remove();
            updateStatus("connecting...")
            console.log("now connecting to stranger");
            socket.send("stranger");
        }

        function friendClick(){
            document.getElementById("page1").remove();
            updateState("Creating game at [address]")
            console.log("TODO")
            socket.send("friend");
        }

        function updateStatus(status){
            document.getElementById("status").innerHTML = "<p>" + status + "</p>";
        }

        function leftPress(){
            socket.send("left");
        }

        function rightPress(){
            socket.send("right");
        }

        function upPress(){
            socket.send("up");
        }

        function downPress(){
            socket.send("down");
        }

        function initializeCanvas(){
            canvas = document.querySelector("#back");
            ctx = canvas.getContext("2d");
            ctx.canvas.width  = 200;
            ctx.canvas.height = 200;
        }

        function initializeKeypresses(){
            window.addEventListener('keydown', function(event) {
                switch (event.keyCode) {
                    case 37: // Left
                        leftPress();
                    break;

                    case 38: // Up
                        upPress();
                    break;

                    case 39: // Right
                        rightPress();
                    break;

                    case 40: // Down
                        downPress();
                    break;
                }
            }, false);
        }

        function initializeSocket(socket){
            socket.onMessage(function(data) {
                if (data == "game beginning"){
                    updateStatus("Game Beginning!")
                }
                else if (data == "confirmed. waiting for stranger"){
                    updateStatus(data);
                }
                else{
                    drawFromMsg(data);
                }

                // Echo the message back to the server.
                //socket.send("echo: " + data);
            });

            socket.on("connected", function() {
                console.log("connected");
            });

            socket.on("connecting", function() {
                console.log("connecting");
            });

            socket.on("disconnected", function() {
                console.log("disconnected");
            });

            socket.on("reconnecting", function() {
                console.log("reconnecting");
            });

            socket.on("error", function(e, msg) {
                console.log("error: " + msg);
            });

            socket.on("connect_timeout", function() {
                console.log("connect_timeout");
            });

            socket.on("timeout", function() {
                console.log("timeout");
            });

            socket.on("discard_send_buffer", function() {
                console.log("some data could not be send and was discarded.");
            });
        }
    </script>
  </body>
</html>